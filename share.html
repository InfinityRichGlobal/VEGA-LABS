<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VEGA • Share Flex</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#f7fafc;color:#111}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08);max-width:520px;width:100%;text-align:center}
    .spinner{width:36px;height:36px;border:3px solid #e5e7eb;border-top-color:#0ea5e9;border-radius:50%;animation:spin 1s linear infinite;margin:12px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>กำลังเตรียมแชร์…</h3>
      <div class="spinner"></div>
      <p id="msg">โปรดรอสักครู่</p>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008326648-P8dmbpRZ'; // ← ใส่ LIFF ID ของ “VEGA Share”
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzcc0iyuSyFxcR6xScstRrMUGNshVNImhcbqT3acDUapY51BRbGIpyyeUxcqsxQOw/exec';  // ← ใส่ Web App URL แบบ .../exec

    (async () => {
      const $msg = (t)=>document.getElementById('msg').textContent=t;

      // อ่าน ?share=FX-...
      const q = new URLSearchParams(location.search);
      const flexId = q.get('share');
      if (!flexId){ $msg('ไม่พบรหัสสำหรับแชร์ (missing ?share=)'); return; }

      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){
          liff.login({ redirectUri: location.href });
          return;
        }

        $msg('กำลังโหลดใบ FLEX…');
        // ขอ FLEX JSON จาก Apps Script
        const resp = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ action:'getFlexById', flexId })
        });
        const data = await resp.json();
        if(data.status!=='success' || !data.flex){ $msg('ไม่พบข้อมูล FLEX สำหรับแชร์'); return; }

        $msg('เปิดตัวเลือกการแชร์…');
        await liff.shareTargetPicker([{
          type:'flex',
          altText:'Order Summary',
          contents:data.flex
        }]);

        liff.closeWindow();
      }catch(err){
        console.error(err);
        $msg('เกิดปัญหาในการแชร์ โปรดลองอีกครั้ง');
      }
    })();
  </script>
</body>
</html>
