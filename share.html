<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="title">VEGA • Share Flex</title>

  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:#f7fafc;
      color:#111;
    }
    .wrap{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
    }
    .card{
      padding:20px;
      max-width:520px;
      width:100%;
      text-align:center;
    }
    h3{ margin:0 0 10px }
    .spinner{
      width:36px;height:36px;
      animation:spin 1s linear infinite;
      margin:12px auto;
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3 id="head">กำลังเตรียมแชร์…</h3>
      <div class="spinner"></div>
      <p id="msg">โปรดรอสักครู่</p>
    </div>
  </div>

<script>
/* ---------------- CONFIG ---------------- */
const LIFF_ID = "2008326648-P8dmbpRZ";   // ← ใส่ LIFF ID share-target-picker
const GAS_URL = "https://script.google.com/macros/s/AKfycbzcc0iyuSyFxcR6xScstRrMUGNshVNImhcbqT3acDUapY51BRbGIpyyeUxcqsxQOw/exec";

/* ---------------- Utils ---------------- */
const el = (id)=>document.getElementById(id);
const setMsg = (title, message)=>{
  el("head").textContent = title;
  el("msg").textContent = message;
  document.title = title;
};

/* ✅ ดึงค่า shareId — รองรับทุกรูปแบบ URL (search, hash, liff.state, redirectUri) */
function getQSParam(name){
  // 1: query ปกติ ?share=FX-xxxx
  const q1 = new URLSearchParams(location.search).get(name);
  if (q1) return q1;

  // 2: อยู่หลัง hash (#/?share=xxxx)
  if (location.hash){
    const hash = location.hash.replace(/^#\/?/, "");
    const hq = hash.includes("?") ? hash.split("?")[1] : "";
    if (hq){
      const q2 = new URLSearchParams(hq).get(name);
      if (q2) return q2;
    }
  }

  // 3: LIFF ย้าย parameter ไว้ใน liff.state
  const state = new URLSearchParams(location.search).get("liff.state");
  if (state){
    const s = decodeURIComponent(state);
    const qs = s.split("?")[1];
    if (qs){
      const q3 = new URLSearchParams(qs).get(name);
      if (q3) return q3;
    }
  }

  // 4: บางครั้งอยู่ใน redirectUri
  const redirect = new URLSearchParams(location.search).get("liff.redirectUri");
  if (redirect){
    try{
      const u = new URL(decodeURIComponent(redirect));
      const q4 = new URLSearchParams(u.search).get(name);
      if (q4) return q4;
    }catch(e){}
  }

  // 5: เผื่อโดน rewrite แปลก ๆ
  const match = location.href.match(new RegExp("[?&]"+name+"=([^&#]+)"));
  return match ? decodeURIComponent(match[1]) : null;
}

/* ---------------- RUN ---------------- */
(async () => {
  const flexId = getQSParam("share");
  if (!flexId){
    setMsg("ไม่พบรหัสสำหรับแชร์", "missing ?share=");
    return;
  }

  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

    setMsg("กำลังโหลดข้อมูล…", "กำลังดึง Flex จากเซิร์ฟเวอร์");

    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded" },
      body: new URLSearchParams({ action:"getFlexById", flexId: flexId })
    });

    const data = await res.json();
    if (data.status !== "success" || !data.flex){
      setMsg("ไม่พบข้อมูล FLEX", "ตรวจสอบว่า flex_id ถูกต้องหรือหมดอายุ");
      return;
    }

    setMsg("เปิดหน้าต่างเลือกแชร์…", "กำลังเปิด Share Target Picker");

    await liff.shareTargetPicker([{
      type: "flex",
      altText: "VEGA • Order Summary",
      contents: data.flex
    }]);

    liff.closeWindow();

  }catch(err){
    console.error(err);
    setMsg("เกิดข้อผิดพลาด", "โปรดลองอีกครั้งหรือติดต่อแอดมิน");
  }
})();
</script>
</body>
</html>
