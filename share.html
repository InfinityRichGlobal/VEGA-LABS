<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="title">VEGA • Share Flex</title>

  <style>
    :root{
      --bg:#f7fafc; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --accent:#0ea5e9; --shadow:0 10px 30px rgba(2,6,23,.08); --radius:16px;
    }
    @media (prefers-color-scheme:dark){
      :root{ --bg:#0b1220; --card:#0f172a; --ink:#e2e8f0; --muted:#94a3b8; --line:#1e293b; --shadow:0 10px 30px rgba(0,0,0,.35) }
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--ink) }
    .wrap{ min-height:100vh; display:grid; place-items:center; padding:24px }
    .card{ width:100%; max-width:520px; background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow); border-radius:var(--radius); padding:24px 22px; text-align:center }
    h3{ margin:0 0 8px; font-size:1.125rem; letter-spacing:.2px }
    p{ margin:6px 0 0; color:var(--muted); font-size:.95rem }
    .spinner{ width:38px; height:38px; border:3px solid var(--line); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin:14px auto 6px }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .hint{ margin-top:14px; font-size:.8rem; color:var(--muted); opacity:.85 }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3 id="head">กำลังเตรียมแชร์…</h3>
      <div class="spinner" aria-hidden="true"></div>
      <p id="msg">โปรดรอสักครู่</p>
      <p class="hint" id="hint"></p>
    </div>
  </div>

<script>
/* ---------------- CONFIG: 2 GAS URLs ---------------- */
const GAS_URLS = [
  "https://script.google.com/macros/s/AKfycbzcc0iyuSyFxcR6xScstRrMUGNshVNImhcbqT3acDUapY51BRbGIpyyeUxcqsxQOw/exec",
  "https://script.google.com/macros/s/AKfycbztXqbQWNcw751NYq5QkMal5PAEJvOJTtrtK6YIXGbbdo_GvITWIQQuaEi0rfxPogY/exec"
];

/* ---------------- Utils ---------------- */
const el = (id)=>document.getElementById(id);
const setMsg = (title, message, hint="")=>{
  el("head").textContent = title;
  el("msg").textContent = message;
  el("hint").textContent = hint;
  document.title = title;
};

function getQSParam(name){
  const q1 = new URLSearchParams(location.search).get(name);
  if (q1) return q1;

  if (location.hash){
    const hash = location.hash.replace(/^#\/?/, "");
    const qs = hash.includes("?") ? hash.split("?")[1] : "";
    if (qs){
      const q2 = new URLSearchParams(qs).get(name);
      if (q2) return q2;
    }
  }

  const state = new URLSearchParams(location.search).get("liff.state");
  if (state){
    try{
      const s = decodeURIComponent(state);
      const qs = s.split("?")[1] || "";
      const q3 = new URLSearchParams(qs).get(name);
      if (q3) return q3;
    }catch(e){}
  }

  const redirect = new URLSearchParams(location.search).get("liff.redirectUri");
  if (redirect){
    try{
      const u = new URL(decodeURIComponent(redirect));
      const q4 = new URLSearchParams(u.search).get(name);
      if (q4) return q4;
    }catch(e){}
  }

  const m = location.href.match(new RegExp("[?&]"+name+"=([^&#]+)"));
  return m ? decodeURIComponent(m[1]) : null;
}

/* ---------------- ✅ Fetch with Fallback (ลองหลาย URLs) ---------------- */
async function fetchWithFallback(action, params = {}){
  const body = new URLSearchParams({ action, ...params });
  
  for (let i = 0; i < GAS_URLS.length; i++) {
    const url = GAS_URLS[i];
    try {
      console.log(`[TRY ${i+1}/${GAS_URLS.length}] Fetching: ${url}`);
      
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      if (!res.ok) {
        console.warn(`[TRY ${i+1}] HTTP ${res.status} - ลอง URL ถัดไป`);
        continue;
      }

      const data = await res.json();
      
      // ถ้า response มี status: 'success' หรือมีข้อมูลที่ต้องการ
      if (data && (data.status === 'success' || data.liff_id_share || data.flex)) {
        console.log(`[SUCCESS] ใช้ URL: ${url}`);
        return data;
      }

      console.warn(`[TRY ${i+1}] Response ไม่ถูกต้อง - ลอง URL ถัดไป`);
    } catch (err) {
      console.error(`[TRY ${i+1}] Error:`, err.message);
      if (i === GAS_URLS.length - 1) {
        throw new Error(`ไม่สามารถเชื่อมต่อ GAS ได้ทั้ง ${GAS_URLS.length} URLs`);
      }
    }
  }

  throw new Error('ไม่พบข้อมูลจากทุก URLs');
}

/* ---------------- RUN ---------------- */
(async () => {
  const flexId = getQSParam("share");
  if (!flexId){
    setMsg("ไม่พบรหัสสำหรับแชร์", "missing ?share=", "ตรวจสอบลิงก์: ต้องมีพารามิเตอร์ ?share=FLEX_ID");
    return;
  }

  try{
    // ✅ ดึง config (ลองหลาย URLs)
    setMsg("กำลังเตรียมแชร์…", "กำลังดึงการตั้งค่า");
    const cfg = await fetchWithFallback("getConfig");
    const liffId = cfg.liff_id_share || "";

    if (!liffId){
      setMsg("การตั้งค่าไม่สมบูรณ์", "ไม่พบ liff_id_share ในชีต Structure", "คีย์: liff_id_share (คอลัมน์ A) / ค่า: LIFF ID (คอลัมน์ B)");
      return;
    }

    await liff.init({ liffId });
    if (!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }

    // ✅ ดึง Flex (ลองหลาย URLs)
    setMsg("กำลังโหลดข้อมูล…", "กำลังดึง Flex จากเซิร์ฟเวอร์");
    const data = await fetchWithFallback("getFlexById", { flexId });

    if (data.status !== "success" || !data.flex){
      setMsg("ไม่พบข้อมูล FLEX", "ตรวจสอบว่า flex_id ถูกต้องหรือหมดอายุ", `flex_id: ${flexId}`);
      return;
    }

    setMsg("เปิดหน้าต่างเลือกแชร์…", "กำลังเปิด Share Target Picker");

    await liff.shareTargetPicker([{
      type: "flex",
      altText: "• VEGA LABS •",
      contents: data.flex
    }]);

    liff.closeWindow();

  }catch(err){
    console.error(err);
    setMsg("เกิดข้อผิดพลาด", err.message || "โปรดลองอีกครั้งหรือติดต่อแอดมิน");
  }
})();
</script>
</body>
</html>
