<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VEGA • Share Flex</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#f7fafc;color:#111}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08);max-width:520px;width:100%;text-align:center}
    .spinner{width:36px;height:36px;border:3px solid #e5e7eb;border-top-color:#0ea5e9;border-radius:50%;animation:spin 1s linear infinite;margin:12px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>กำลังเตรียมแชร์…</h3>
      <div class="spinner"></div>
      <p id="msg">โปรดรอสักครู่</p>
    </div>
  </div>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID = '2008326648-P8dmbpRZ';          // ← ของคุณ
  const GAS_URL = 'YOUR_GAS_EXEC_URL';            // ← ของคุณ (.../exec)

  const el = (id)=>document.getElementById(id);
  const setMsg = (t,m)=>{ el('title').textContent=t; el('msg').textContent=m; };

  // ✅ ดึงพารามิเตอร์แบบกันเหนียว (search, hash, href)
  function getQSParam(name){
    // 1) ปกติ
    const s1 = new URLSearchParams(location.search).get(name);
    if (s1) return s1;

    // 2) ถูกย้ายไปหลัง #
    if (location.hash){
      // รูปแบบที่เจอบ่อย: #/path?share=FX-...  หรือ #?share=FX-...
      const hash = location.hash.replace(/^#\/?/, '');        // ตัด # หรือ #/
      const qstr = hash.includes('?') ? hash.split('?')[1] : '';
      if (qstr){
        const s2 = new URLSearchParams(qstr).get(name);
        if (s2) return s2;
      }
    }

    // 3) เผื่อโดนรีไรต์แปลกๆ: ดึงจาก href โดยตรง
    const m = location.href.match(new RegExp('[?&]'+name+'=([^&#]+)'));
    return m ? decodeURIComponent(m[1]) : null;
  }

  (async () => {
    const flexId = getQSParam('share');
    if (!flexId){ setMsg('ไม่พบรหัสสำหรับแชร์','missing ?share='); return; }

    try{
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()){
        liff.login({ redirectUri: location.href });
        return;
      }

      setMsg('กำลังโหลดข้อมูล…','กำลังดึง FLEX จากเซิร์ฟเวอร์');
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action:'getFlexById', flexId })
      });
      const data = await res.json();
      if (data.status !== 'success' || !data.flex){
        setMsg('ไม่พบข้อมูล FLEX','ตรวจสอบว่า flex_id ถูกต้องหรือหมดอายุ');
        return;
      }

      setMsg('เปิดตัวเลือกการแชร์…','กำลังเปิด Share Target Picker');
      await liff.shareTargetPicker([{ type:'flex', altText:'Order Summary', contents:data.flex }]);
      liff.closeWindow();

    }catch(err){
      console.error(err);
      setMsg('เกิดข้อผิดพลาด','โปรดลองอีกครั้งหรือติดต่อแอดมิน');
    }
  })();
</script>

</body>
</html>
