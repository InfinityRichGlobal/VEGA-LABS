<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vega Labs | Access Portal</title>
  <meta name="description" content="Vega | Access Portal" />
  <link rel="shortcut icon" href="https://lh3.googleusercontent.com/d/1cqrmGHF5k12P-cP6P5TQtM2jPAqBMLSN" />

  <!-- Preconnect ให้โหลดเร็วขึ้น -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #f5f6f7; /* Soft wellness gray */
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Helvetica, Arial;
    }

    #frame {
      width: 100%;
      height: 100dvh;
      border: 0;
      background: #ffffff;
      display: none;
    }

    .loading {
      height: 100vh;
      width: 100%;
      display: grid;
      place-items: center;
      font-size: 1.1rem;
      color: #3a3a3c;
      font-weight: 500;
    }
  </style>
</head>
<body>

  <div class="loading" id="loading">
    กำลังโหลดระบบ...
  </div>

  <iframe id="frame" referrerpolicy="strict-origin-when-cross-origin"></iframe>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    /* ✅ CONFIG ONLY  */
    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzKDQTfy86iMg6KGb4eT3f0YjvnQ8GsKQhz_or1TmYlrHL_ZqVOFdhJc5EF6E51VMCt/exec";   // ← ใส่ของคุณ
    const MY_LIFF_ID   = "2008326648-1rvaEdLR";                // ← ใส่ของคุณ

    /* ✅ DOM ref */
    const iframeEl = document.getElementById("frame");
    const loadingEl = document.getElementById("loading");

    (async () => {
      // เก็บ query เดิมไว้ แต่ลบ uid เดิมก่อน
      const usp = new URLSearchParams(location.search);
      usp.delete("uid");

      const REDIRECT_URI = location.origin + location.pathname + (usp.toString() ? `?${usp.toString()}` : "");

      try {
        await liff.init({ liffId: MY_LIFF_ID, withLoginOnExternalBrowser: true });

        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: REDIRECT_URI });
          return;
        }

        const profile = await liff.getProfile().catch(() => ({}));
        const decoded = liff.getDecodedIDToken?.() || {};
        const uid = decoded.sub || profile.userId || "";

        if (uid) {
          // ✅ logLiff: บันทึก Log แต่ไม่ส่ง Notify
          fetch(GAS_EXEC_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
              action: "logLiff",
              userId: uid,
              displayName: profile.displayName || "",
              pictureUrl: profile.pictureUrl || ""
            })
          }).catch(() => {});
        }

        // ✅ เปิด iframe พร้อม uid เพื่อให้ WebApp ทำงานต่อ
        const params = new URLSearchParams(usp);
        if (uid) params.set("uid", uid);
        const url = GAS_EXEC_URL + (params.toString() ? `?${params.toString()}` : "");

        iframeEl.src = url;
        iframeEl.style.display = "block";
        loadingEl.style.display = "none";

      } catch (err) {
        iframeEl.src = GAS_EXEC_URL;
        iframeEl.style.display = "block";
        loadingEl.style.display = "none";
      }
    })();
  </script>

</body>
</html>
