<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>VEGA LABS</title>
  <!-- สำคัญ: เปิด edge-to-edge เต็มหน้าจอจริง -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="VEGA LABS ASS." />
  <link rel="shortcut icon" href="https://lh3.googleusercontent.com/d/1cqrmGHF5k12P-cP6P5TQtM2jPAqBMLSN" />

  <!-- เร่งการเชื่อมต่อ -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>

  <style>
    :root{
      --bg:#fff; --ink:#111827;
      /* เผื่อมี notch (iOS/LINE) */
      --safe-top: env(safe-area-inset-top);
      --safe-right: env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
    }
    /* ล้างทุกอย่างให้กางเต็มจริง ๆ */
    html, body {
      margin:0; padding:0; height:100%;
      background:var(--bg); color:var(--ink);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden; /* กันการเลื่อนที่ตัวแม่ */
    }
    /* กัน CSS ภายนอกหรือ theme ไปกำหนดความกว้างสูงสุด */
    html, body, #app, #wrap {
      max-width:none !important;
    }
    /* Iframe เต็มจอแบบ fixed + safe-area */
    .frame {
      position:fixed;
      inset:0;               /* top/right/bottom/left = 0 */
      width:100vw;
      height:100svh;         /* ดีกว่า 100vh บนมือถือ */
      border:0;
      display:block;         /* โชว์ทันทีตามที่ต้องการ */
      background:#fff;
      padding-top:var(--safe-top);
      padding-right:var(--safe-right);
      padding-bottom:var(--safe-bottom);
      padding-left:var(--safe-left);
      box-sizing:border-box;
    }

    /* ป้องกัน flex/center ใด ๆ ใน body ที่อาจเคยทำให้ดู “แคป” */
    body { display:block; }
  </style>
</head>
<body>
  <iframe id="myIframe" class="frame" referrerpolicy="strict-origin-when-cross-origin"></iframe>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // === ค่าจริงของโปรเจกต์คุณ ===
    const GAS_EXEC_URL = 'https://script.google.com/macros/s/AKfycbzcc0iyuSyFxcR6xScstRrMUGNshVNImhcbqT3acDUapY51BRbGIpyyeUxcqsxQOw/exec';
    const MY_LIFF_ID   = '2008326648-y4KXg6Ax';

    const iframe = document.getElementById('myIframe');

    (async () => {
      // เก็บพารามิเตอร์เดิมไว้ (ลบ uid เดิมกันซ้ำ)
      const usp = new URLSearchParams(location.search);
      usp.delete('uid');

      // redirectUri แบบสะอาด (ไม่มี hash / uid ซ้ำ)
      const REDIRECT_URI = location.origin + location.pathname + (usp.toString() ? `?${usp.toString()}` : '');

      try {
        await liff.init({ liffId: MY_LIFF_ID, withLoginOnExternalBrowser: true });

        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: REDIRECT_URI });
          return; // จะรีไดเรกต์ไปล็อกอินแล้วกลับมา
        }

        // ล็อกอินแล้ว → ดึง userId
        const profile      = await liff.getProfile().catch(() => ({}));
        const decodedToken = liff.getDecodedIDToken?.() || {};
        const userId       = decodedToken.sub || profile.userId || '';

        // ส่ง log ไป GAS (non-blocking)
        if (userId) {
          fetch(GAS_EXEC_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              action: 'logLiff',
              userId,
              displayName: profile.displayName || '',
              pictureUrl: profile.pictureUrl || ''
            })
          }).catch(()=>{});
        }

        // เปิด iframe พร้อม uid
        const params = new URLSearchParams(usp);
        if (userId) params.set('uid', userId);
        iframe.src = GAS_EXEC_URL + (params.toString() ? `?${params.toString()}` : '');

      } catch (e) {
        // Fallback: ถ้า LIFF ใช้งานไม่ได้ ให้เปิด iframe ตรง ๆ
        iframe.src = GAS_EXEC_URL;
      }
      // ไม่ต้องซ่อน/แสดงภายหลัง — แสดง block ตั้งแต่แรกเพื่อไม่ให้ “แคป”
    })();
  </script>
</body>
</html>
