<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vega Labs | Access Portal</title>
  <meta name="description" content="Vega | Access Portal" />
  <link rel="shortcut icon" href="https://lh3.googleusercontent.com/d/1cqrmGHF5k12P-cP6P5TQtM2jPAqBMLSN" />


  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>

  <style>
    :root{
      --bg:#f5f6f7; --ink:#111827; --card:#ffffff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    #wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
    header{padding:10px 16px}
    .brand{font-weight:600;letter-spacing:.2px;opacity:.7;font-size:clamp(14px,2.5vw,16px)}
    #loading{display:grid;place-items:center;min-height:40dvh;font-size:clamp(14px,2.8vw,18px);opacity:.8}
    #frame{width:100%;height:calc(100dvh - 48px);border:0;background:var(--card);display:none}
  </style>
</head>
<body>
  <div id="wrap">
    <header><div class="brand">Vega Wellness · Access</div></header>
    <div id="loading">กำลังโหลดระบบ...</div>
    <iframe id="frame" referrerpolicy="strict-origin-when-cross-origin"></iframe>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    /* ✅ CONFIG ONLY  */
    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzKDQTfy86iMg6KGb4eT3f0YjvnQ8GsKQhz_or1TmYlrHL_ZqVOFdhJc5EF6E51VMCt/exec";   // ← ใส่ของคุณ
    const MY_LIFF_ID   = "2008326648-1rvaEdLR";                // ← ใส่ของคุณ

    const frame = document.getElementById("frame");
    const loading = document.getElementById("loading");

    (async () => {
      const usp = new URLSearchParams(location.search);
      usp.delete("uid");
      const REDIRECT_URI = location.origin + location.pathname + (usp.toString() ? `?${usp.toString()}` : "");

      try{
        await liff.init({ liffId: MY_LIFF_ID, withLoginOnExternalBrowser: true });
        if(!liff.isLoggedIn()){
          liff.login({ redirectUri: REDIRECT_URI });
          return;
        }
        const profile = await liff.getProfile().catch(()=>({}));
        const decoded = liff.getDecodedIDToken?.() || {};
        const uid = decoded.sub || profile.userId || "";

        // log เข้าเว็บ (ไม่ notify)
        if(uid){
          fetch(GAS_EXEC_URL, {
            method:"POST",
            headers:{"Content-Type":"application/x-www-form-urlencoded"},
            body: new URLSearchParams({
              action:"logLiff",
              userId: uid,
              displayName: profile.displayName || "",
              pictureUrl: profile.pictureUrl || ""
            })
          }).catch(()=>{});
        }

        // เปิด iframe พร้อม uid
        const params = new URLSearchParams(usp);
        if(uid) params.set("uid", uid);
        frame.src = GAS_EXEC_URL + (params.toString() ? `?${params.toString()}` : "");
      }catch(err){
        // fallback
        frame.src = GAS_EXEC_URL;
      }finally{
        frame.style.display = "block";
        loading.style.display = "none";
      }
    })();
  </script>
</body>
</html>
