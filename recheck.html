<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vega Labs | Access Portal</title>
  <meta name="description" content="Vega | Access Portal" />
  <link rel="shortcut icon" href="https://lh3.googleusercontent.com/d/1cqrmGHF5k12P-cP6P5TQtM2jPAqBMLSN" />

  <style>
    :root{ 
      --bg:#f5f6f7; 
      --ink:#111827;
      --safe-top: env(safe-area-inset-top);
      --safe-right: env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
    }

    /* กางเต็มจอจริง ๆ: header auto + iframe 1fr */
    html, body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
    }
    body{
      min-height:100svh;
      display:grid;
      grid-template-rows:auto 1fr;
      padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
      box-sizing:border-box;
      overflow:hidden; /* กันการเลื่อนที่ body */
    }

    header{
      text-align:center;
      padding:12px 8px 6px;
    }
    header .main{font-size:1.4rem;font-weight:700;letter-spacing:.6px}
    header .sub{font-size:.9rem;font-weight:400;opacity:.7;margin-top:4px}

    #loading{
      text-align:center;
      font-size:.9rem;
      opacity:.7;
      padding:6px 0 10px;
    }

    /* iframe ต้องกินพื้นที่ที่เหลือทั้งหมด */
    #frame{
      width:100vw;     /* กว้างสุดขอบ viewport */
      height:100%;     /* สูงเท่าพื้นที่แถวที่ 2 (1fr) */
      border:0;
      background:#fff;
      display:none;    /* โชว์เมื่อพร้อม */
    }
  </style>
</head>
<body>
  <header>
    <div class="main">VEGA LABS | ACCESS PORTAL</div>
    <div class="sub">ระบบบันทึกและตรวจสอบออเดอร์</div>
    <div id="loading">กำลังโหลดระบบ...</div>
  </header>

  <iframe id="frame" referrerpolicy="strict-origin-when-cross-origin"></iframe>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzKDQTfy86iMg6KGb4eT3f0YjvnQ8GsKQhz_or1TmYlrHL_ZqVOFdhJc5EF6E51VMCt/exec";
    const MY_LIFF_ID   = "2008326648-1rvaEdLR";

    const frame   = document.getElementById("frame");
    const loading = document.getElementById("loading");

    (async () => {
      const usp = new URLSearchParams(location.search);
      usp.delete("uid");

      // แก้บั๊ก template string ตรงนี้
      const REDIRECT_URI = location.origin + location.pathname + (usp.toString() ? `?${usp.toString()}` : "");

      try{
        await liff.init({ liffId: MY_LIFF_ID, withLoginOnExternalBrowser:true });

        if(!liff.isLoggedIn()){
          liff.login({ redirectUri: REDIRECT_URI });
          return;
        }

        const profile = await liff.getProfile().catch(()=>({}));
        const decoded = liff.getDecodedIDToken?.() || {};
        const uid     = decoded.sub || profile.userId || "";

        if(uid){
          // ส่ง log แบบ non-blocking
          fetch(GAS_EXEC_URL, {
            method:"POST",
            headers:{ "Content-Type":"application/x-www-form-urlencoded" },
            body:new URLSearchParams({
              action     : "logLiff",
              userId     : uid,              /* ← ใช้ uid ที่นี่ */
              displayName: profile.displayName || "",
              pictureUrl : profile.pictureUrl  || ""
            })
          }).catch(()=>{});
        }

        const params = new URLSearchParams(usp);
        if(uid) params.set("uid", uid);

        // แก้บั๊ก template string ตรงนี้ด้วย
        frame.src = GAS_EXEC_URL + (params.toString() ? `?${params.toString()}` : "");
      }catch(err){
        frame.src = GAS_EXEC_URL;
      }finally{
        loading.style.display = "none";
        frame.style.display = "block";
      }
    })();
  </script>
</body>
</html>
