<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Wanvera Vega Wellness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Wanvera Vega Wellness ASS." />
  <link rel="shortcut icon" href="https://lh3.googleusercontent.com/d/1ppuPNX6BJETu6uPbgaoUZboUh6Eh7GGm" />

  <!-- เร่งการเชื่อมต่อ -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>

  <style>
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,Arial}
    .frame{width:100%;height:100dvh;border:0;display:none;background:#fff}
  </style>
</head>
<body>
  <!-- ไม่มีสปินเนอร์/ข้อความ เพิ่มความเรียบ -->
  <iframe id="myIframe" class="frame" referrerpolicy="strict-origin-when-cross-origin"></iframe>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // === ค่าจริงของโปรเจกต์คุณ ===
    const GAS_EXEC_URL = 'https://script.google.com/macros/s/AKfycbztXqbQWNcw751NYq5QkMal5PAEJvOJTtrtK6YIXGbbdo_GvITWIQQuaEi0rfxPogY/exec';
    const MY_LIFF_ID   = '2008326648-y8Q2LBOo';

    const iframe = document.getElementById('myIframe');

    (async () => {
      // เก็บพารามิเตอร์เดิมไว้ (ยกเว้น uid ถ้ามี)
      const usp = new URLSearchParams(location.search);
      usp.delete('uid');

      // ใช้ redirectUri แบบไม่ติด hash
      const REDIRECT_URI = location.origin + location.pathname + (usp.toString() ? `?${usp.toString()}` : '');

      try {
        await liff.init({ liffId: MY_LIFF_ID, withLoginOnExternalBrowser: true });

        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: REDIRECT_URI });
          return; // จะถูกรีไดเรกต์ออกไป
        }

        // ล็อกอินแล้ว → ดึงโปรไฟล์เพื่อเอา userId
        const profile      = await liff.getProfile().catch(() => ({}));
        const decodedToken = liff.getDecodedIDToken?.() || {};
        const userId       = decodedToken.sub || profile.userId || '';

        // ยิง log (ไม่บล็อก UI)
        if (userId) {
          fetch(GAS_EXEC_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              action: 'logLiff',
              userId,
              displayName: profile.displayName || '',
              pictureUrl: profile.pictureUrl || ''
            })
          }).catch(()=>{});
        }

        // เปิด iframe พร้อม uid ทันที
        const params = new URLSearchParams(usp);
        if (userId) params.set('uid', userId);
        const url = GAS_EXEC_URL + (params.toString() ? `?${params.toString()}` : '');
        iframe.src = url;
        iframe.style.display = 'block';

      } catch (e) {
        // ถ้า init ผิดพลาด (เช่น โดนบล็อคสคริปต์) ให้แสดงฟอร์มเปล่าเป็น fallback
        iframe.src = GAS_EXEC_URL;
        iframe.style.display = 'block';
      }
    })();
  </script>
  <script src="./redirect.js"></script>

</body>
</html>
