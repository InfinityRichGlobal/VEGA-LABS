<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>VEGA LABS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="VEGA LABS ASS." />
  <link rel="shortcut icon" href="https://lh3.googleusercontent.com/d/1cqrmGHF5k12P-cP6P5TQtM2jPAqBMLSN" />
  <style>
    html,body { 
      height:100%; margin:0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .wrap { 
      height:100%; 
      display:flex; 
      align-items:center; 
      justify-content:center;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    .logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      color: #1a202c;
    }
    .subtitle {
      color: #718096;
      font-size: 14px;
      margin: 0 0 30px;
    }
    .status {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .status-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
    }
    .status-label {
      color: #4a5568;
    }
    .status-value {
      font-weight: 600;
      color: #2d3748;
    }
    .status-value.loading {
      color: #667eea;
    }
    .status-value.success {
      color: #48bb78;
    }
    .status-value.error {
      color: #f56565;
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .error-box {
      background: #fff5f5;
      border: 1px solid #fc8181;
      color: #c53030;
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 13px;
      text-align: left;
    }
    .debug-info {
      margin-top: 20px;
      padding: 15px;
      background: #f7fafc;
      border-radius: 8px;
      font-size: 11px;
      font-family: 'Courier New', monospace;
      text-align: left;
      color: #4a5568;
      max-height: 200px;
      overflow-y: auto;
    }
    .profile-box {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: #f7fafc;
      border-radius: 12px;
      margin: 20px 0;
    }
    .profile-pic {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    .profile-info {
      flex: 1;
      text-align: left;
    }
    .profile-name {
      font-weight: 600;
      color: #2d3748;
      margin: 0 0 4px;
    }
    .profile-id {
      font-size: 11px;
      color: #718096;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="logo">üîó</div>
      <h1>VEGA LABS</h1>
      <p class="subtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...</p>

      <!-- Status Display -->
      <div class="status">
        <div class="status-item">
          <span class="status-label">LIFF SDK</span>
          <span id="statusSDK" class="status-value loading">
            <span class="spinner"></span> ‡πÇ‡∏´‡∏•‡∏î...
          </span>
        </div>
        <div class="status-item">
          <span class="status-label">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
          <span id="statusLogin" class="status-value">‡∏£‡∏≠...</span>
        </div>
        <div class="status-item">
          <span class="status-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
          <span id="statusProfile" class="status-value">‡∏£‡∏≠...</span>
        </div>
      </div>

      <!-- Profile Display -->
      <div id="profileBox" style="display:none" class="profile-box">
        <img id="profilePic" class="profile-pic" src="" alt="Profile">
        <div class="profile-info">
          <div id="profileName" class="profile-name">-</div>
          <div id="profileId" class="profile-id">-</div>
        </div>
      </div>

      <!-- Error Display -->
      <div id="errorBox" class="error-box" style="display:none"></div>

      <!-- Manual Test Button -->
      <button id="testBtn" class="btn" style="display:none">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ LINE</button>

      <!-- Debug Info -->
      <div id="debugInfo" class="debug-info" style="display:none"></div>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <script>
    const GAS_EXEC_URL = 'https://script.google.com/macros/s/AKfycbzcc0iyuSyFxcR6xScstRrMUGNshVNImhcbqT3acDUapY51BRbGIpyyeUxcqsxQOw/exec';
    const MY_LIFF_ID   = '2008326648-y4KXg6Ax';
    
    // Elements
    const statusSDK = document.getElementById('statusSDK');
    const statusLogin = document.getElementById('statusLogin');
    const statusProfile = document.getElementById('statusProfile');
    const errorBox = document.getElementById('errorBox');
    const debugInfo = document.getElementById('debugInfo');
    const profileBox = document.getElementById('profileBox');
    const testBtn = document.getElementById('testBtn');

    // Debug log array
    const logs = [];
    function log(msg, isError = false) {
      const timestamp = new Date().toLocaleTimeString('th-TH');
      const logMsg = `[${timestamp}] ${msg}`;
      logs.push(logMsg);
      console.log(isError ? '‚ùå' : '‚úÖ', msg);
      debugInfo.innerHTML = logs.join('\n');
      debugInfo.style.display = 'block';
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
      log(`ERROR: ${msg}`, true);
    }

    function updateStatus(element, text, type = 'loading') {
      element.className = `status-value ${type}`;
      if (type === 'loading') {
        element.innerHTML = `<span class="spinner"></span> ${text}`;
      } else if (type === 'success') {
        element.textContent = `‚úì ${text}`;
      } else if (type === 'error') {
        element.textContent = `‚úó ${text}`;
      } else {
        element.textContent = text;
      }
    }

    function redirectToForm(profile = null) {
      let targetUrl = GAS_EXEC_URL;
      
      if (profile) {
        // ‚úÖ FIX: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô sessionStorage ‡∏Å‡πà‡∏≠‡∏ô redirect
        sessionStorage.setItem('liffProfile', JSON.stringify({
          userId: profile.userId || '',
          displayName: profile.displayName || '',
          pictureUrl: profile.pictureUrl || ''
        }));
        log('Profile saved to sessionStorage');
        
        const qs = new URLSearchParams({
          luid: profile.userId || '',
          lname: profile.displayName || '',
          lpict: profile.pictureUrl || ''
        }).toString();
        targetUrl += '?' + qs;
        log(`Redirect URL: ${targetUrl}`);
      } else {
        log('Redirect without profile data');
      }

      setTimeout(() => {
        window.location.href = targetUrl;
      }, 1000);
    }

    // Test mode button
    testBtn.addEventListener('click', () => {
      log('Manual test mode activated');
      redirectToForm(null);
    });

    // Main initialization
    (async () => {
      log('Starting LIFF initialization...');

      // Check for test mode
      const usp = new URLSearchParams(location.search);
      if (usp.get('noliff') === '1') {
        log('Test mode (no LIFF)');
        updateStatus(statusSDK, '‡∏Ç‡πâ‡∏≤‡∏°', 'success');
        updateStatus(statusLogin, '‡∏Ç‡πâ‡∏≤‡∏°', 'success');
        updateStatus(statusProfile, '‡∏Ç‡πâ‡∏≤‡∏°', 'success');
        redirectToForm(null);
        return;
      }

      // Check if we just came back from OAuth
      if (usp.get('createOAuthDialog') === 'true') {
        log('‚ö†Ô∏è Detected OAuth redirect - clearing and retrying...');
        // Clear the URL and retry
        window.history.replaceState({}, document.title, window.location.pathname);
        setTimeout(() => location.reload(), 500);
        return;
      }

      try {
        // Step 1: Check LIFF SDK
        if (typeof liff === 'undefined') {
          throw new Error('LIFF SDK not loaded');
        }
        updateStatus(statusSDK, '‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        log('LIFF SDK loaded successfully');

        // Step 2: Initialize LIFF
        log(`Initializing LIFF with ID: ${MY_LIFF_ID}`);
        await liff.init({ liffId: MY_LIFF_ID });
        log('LIFF initialized');

        // Step 3: Check login status
        updateStatus(statusLogin, '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', 'loading');
        const isLoggedIn = liff.isLoggedIn();
        log(`Login status: ${isLoggedIn}`);

        if (!isLoggedIn) {
          updateStatus(statusLogin, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Login...', 'loading');
          log('Not logged in - starting login flow...');
          
          // Use current URL without query params
          const redirectUri = window.location.origin + window.location.pathname;
          log(`Redirect URI: ${redirectUri}`);
          
          liff.login({ redirectUri });
          return;
        }

        updateStatus(statusLogin, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success');
        log('Already logged in');

        // Step 4: Get profile
        updateStatus(statusProfile, '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'loading');
        log('Fetching profile...');
        
        const profile = await liff.getProfile();
        
        if (!profile || !profile.userId) {
          throw new Error('Failed to get profile data');
        }

        log(`Profile retrieved: ${profile.displayName} (${profile.userId})`);
        updateStatus(statusProfile, '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');

        // Show profile
        profileBox.style.display = 'flex';
        document.getElementById('profilePic').src = profile.pictureUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="50" fill="%23ccc"/%3E%3C/svg%3E';
        document.getElementById('profileName').textContent = profile.displayName || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠';
        document.getElementById('profileId').textContent = profile.userId;

        // Step 5: Redirect to form
        log('Preparing to redirect...');
        document.querySelector('.subtitle').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°...';
        
        redirectToForm(profile);

      } catch (error) {
        log(`Error: ${error.message}`, true);
        console.error('LIFF Error:', error);

        updateStatus(statusSDK, '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        updateStatus(statusLogin, '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
        updateStatus(statusProfile, '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');

        showError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ'}`);

        // Show test button
        testBtn.style.display = 'block';
        testBtn.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE';
      }
    })();
  </script>
</body>
</html>
