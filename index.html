<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>VEGA LABS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="VEGA LABS ASS." />
  <link rel="shortcut icon" href="https://lh3.googleusercontent.com/d/1cqrmGHF5k12P-cP6P5TQtM2jPAqBMLSN" />
  <style>
    html,body { height:100%; margin:0; font-family: system-ui, Arial; background:#f7fafc; }
    .wrap { height:100%; display:grid; place-items:center; }
    .frame { width:100%; height:100vh; border:0; background:#fff; }
    .loader { display:grid; place-items:center; gap:8px; color:#374151; padding:20px; }
    .spinner{ width:36px; height:36px; border:3px solid #e5e7eb; border-top-color:#0ea5e9; border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{to{ transform:rotate(360deg) }}
    .muted { color:#6b7280; font-size:12px; }
    .status { color:#10b981; font-size:13px; margin-top:8px; }
    .error { color:#ef4444; font-size:13px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="loading" class="loader">
      <div class="spinner"></div>
      <div id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</div>
      <div class="muted" id="loadingSub">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
      <div id="statusMsg" class="status" style="display:none"></div>
    </div>
    <iframe id="myIframe" class="frame" style="display:none"></iframe>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <script>
    const GAS_EXEC_URL = 'https://script.google.com/macros/s/AKfycbzcc0iyuSyFxcR6xScstRrMUGNshVNImhcbqT3acDUapY51BRbGIpyyeUxcqsxQOw/exec';
    const MY_LIFF_ID   = '2008326648-y4KXg6Ax';
    
    const iframe      = document.getElementById('myIframe');
    const loading     = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    const loadingSub  = document.getElementById('loadingSub');
    const statusMsg   = document.getElementById('statusMsg');

    function showStatus(msg, isError = false) {
      statusMsg.textContent = msg;
      statusMsg.className = isError ? 'error' : 'status';
      statusMsg.style.display = 'block';
      console.log(isError ? '‚ùå' : '‚úÖ', msg);
    }

    function showFrame(url) {
      iframe.src = url;
      loading.style.display = 'none';
      iframe.style.display = 'block';
    }

    (async () => {
      // ===== ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ó‡∏™ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ LIFF) =====
      const usp = new URLSearchParams(location.search);
      if (usp.get('noliff') === '1') {
        showStatus('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ LIFF)');
        setTimeout(() => showFrame(GAS_EXEC_URL), 500);
        return;
      }

      // ===== ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ LIFF SDK ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà =====
      if (typeof liff === 'undefined') {
        loadingText.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF SDK';
        showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î SDK ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á...', true);
        setTimeout(() => location.reload(), 2000);
        return;
      }

      try {
        // ===== 1. Initialize LIFF =====
        loadingText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...';
        await liff.init({ liffId: MY_LIFF_ID });
        showStatus('‚úì ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

        // ===== 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login Status =====
        if (!liff.isLoggedIn()) {
          loadingText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á Login...';
          loadingSub.textContent = '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà LINE ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
          showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡πÑ‡∏õ LINE Login...');
          
          // ‚úÖ FIX: ‡πÉ‡∏ä‡πâ redirectUri ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏ï‡∏±‡∏î query string ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å)
          const cleanUrl = location.origin + location.pathname;
          liff.login({ redirectUri: cleanUrl });
          return;
        }

        // ===== 3. ‡πÑ‡∏î‡πâ Login ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå =====
        loadingText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...';
        showStatus('‚úì Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        
        const profile = await liff.getProfile();
        
        // ===== 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á =====
        if (!profile || !profile.userId) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ');
        }

        showStatus(`‚úì ‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ${profile.displayName || profile.userId}`);
        
        // ===== 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á Query String =====
        const qs = new URLSearchParams({
          luid:  profile.userId || '',
          lname: profile.displayName || '',
          lpict: profile.pictureUrl || ''
        }).toString();

        // ===== üîç DEBUG =====
        console.log('========== LIFF SUCCESS ==========');
        console.log('Profile:', profile);
        console.log('Query String:', qs);
        console.log('Full URL:', GAS_EXEC_URL + '?' + qs);
        console.log('==================================');

        // ===== 6. ‡πÄ‡∏õ‡∏¥‡∏î iframe ‡∏û‡∏£‡πâ‡∏≠‡∏° Query String =====
        loadingText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°...';
        showStatus('‚úì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°...');
        
        setTimeout(() => {
          showFrame(GAS_EXEC_URL + '?' + qs);
        }, 500);

      } catch (error) {
        // ===== ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error =====
        console.error('‚ùå LIFF Error:', error);
        
        loadingText.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        loadingSub.textContent = error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ';
        showStatus(`‚ùå ${error.message}`, true);

        // ‡∏ñ‡πâ‡∏≤ error ‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        if (error.code === 'INIT_FAILED' || error.message.includes('403')) {
          showStatus('‚ö†Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE', true);
          setTimeout(() => showFrame(GAS_EXEC_URL), 2000);
        }
      }
    })();
  </script>
</body>
</html>
